<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>交通会社経営ゲーム 完全版</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html,body,#map{height:100%;margin:0;padding:0;font-family:"Noto Sans JP",Arial,sans-serif;}
.tabs{position:absolute;left:10px;top:10px;z-index:1001;display:flex;}
.tab{padding:6px 12px;background:rgba(255,255,255,0.9);border-radius:6px 6px 0 0;margin-right:2px;cursor:pointer;font-weight:bold;}
.tab.active{background:#2364a5;color:white;}
.tabContent{position:absolute;left:10px;top:40px;background:rgba(255,255,255,0.95);border-radius:8px;padding:8px;width:280px;font-size:13px;z-index:1000;}
.btn{padding:4px 8px;margin:2px 0;border:none;border-radius:4px;cursor:pointer;background:#2c7dce;color:white;width:100%;}
.btn.active{background:#2364a5;}
.hud{position:absolute;right:10px;top:10px;width:220px;background:rgba(255,255,255,0.95);border-radius:8px;padding:6px;font-size:13px;z-index:1000;}
</style>
</head>
<body>
<div id="map"></div>

<div class="tabs">
  <div class="tab active" data-tab="buildTab">駅・線路作成</div>
  <div class="tab" data-tab="routeTab">路線管理</div>
</div>

<div id="buildTab" class="tabContent">
  <button class="btn" id="btnPlaceStation">駅設置モード</button>
  <button class="btn" id="btnLayTrack">線路敷設モード</button>
  <button class="btn" id="btnEditTrack">線路折れ曲げ編集</button>
  <button class="btn" id="btnAddStationOnTrack">線路上に駅追加</button>
</div>

<div id="routeTab" class="tabContent" style="display:none">
  <input type="text" id="routeName" placeholder="路線名" style="width:100%;margin-bottom:4px;">
  <input type="color" id="routeColor" value="#e67e22" style="width:100%;margin-bottom:4px;">
  <button class="btn" id="btnRouteMode">路線作成モード</button>
  <button class="btn" id="btnRouteRegister" disabled>路線登録</button>
</div>

<div class="hud" id="hud">
  <div>会社名: <span id="compName">YMS Transit</span></div>
  <div>資金: <span id="funds">¥10000000</span></div>
  <div>駅数: <span id="stationCount">0</span></div>
  <div>路線数: <span id="routeCount">0</span></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ------------------- マップ初期化 -------------------
const map = L.map('map').setView([35.681236,139.767125],10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; OSM & CartoDB', maxZoom:19
}).addTo(map);
const stationLayer = L.layerGroup().addTo(map);
const trackLayer = L.layerGroup().addTo(map);
const vehicleLayer = L.layerGroup().addTo(map);

// ------------------- データ -------------------
const Company={funds:10000000,stations:{},routes:[],nextStationId:1,nextRouteId:1};

// ------------------- タブ切替 -------------------
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tabContent').forEach(c=>c.style.display='none');
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).style.display='block';
  };
});

// ------------------- HUD -------------------
function updateHUD(){
  document.getElementById('funds').innerText='¥'+Company.funds.toLocaleString();
  document.getElementById('stationCount').innerText=Object.keys(Company.stations).length;
  document.getElementById('routeCount').innerText=Company.routes.length;
}

// ------------------- モード -------------------
let mode=null,tempTrackPoints=[],tempRouteStations=[],editingPolyline=null;

// ------------------- 駅設置 -------------------
document.getElementById('btnPlaceStation').onclick=()=>{
  mode='station';
  document.querySelectorAll('#buildTab .btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('btnPlaceStation').classList.add('active');
};
map.on('click',e=>{
  if(mode==='station'){
    if(Company.funds<200000){alert('資金不足'); return;}
    Company.funds-=200000;
    const id=Company.nextStationId++;
    const marker=L.circleMarker(e.latlng,{radius:8,color:'#2c7dce',fillColor:'#fff',fillOpacity:1,weight:2}).addTo(stationLayer);
    marker.on('click',()=>onStationClick(id));
    marker.dragging=new L.Handler.MarkerDrag(marker);
    marker.dragging.enable();
    Company.stations[id]={id,latlng:e.latlng,marker};
    updateHUD();
  } else if(mode==='layTrack'){
    tempTrackPoints.push(e.latlng);
    if(tempTrackPoints.length>1){
      if(Company.funds<150000){alert('資金不足'); tempTrackPoints.pop(); return;}
      Company.funds-=150000;
      L.polyline(tempTrackPoints,{color:'#2364a5',weight:5,opacity:0.7}).addTo(trackLayer);
    }
  }
});

// ------------------- 線路敷設 -------------------
document.getElementById('btnLayTrack').onclick=()=>{
  mode='layTrack'; tempTrackPoints=[];
  document.querySelectorAll('#buildTab .btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('btnLayTrack').classList.add('active');
};

// ------------------- 線路折れ曲げ編集 -------------------
document.getElementById('btnEditTrack').onclick=()=>{
  mode='editTrack';
  document.querySelectorAll('#buildTab .btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('btnEditTrack').classList.add('active');
  editingPolyline=null;
};
trackLayer.on('click',e=>{
  if(mode==='editTrack'){
    // クリックした線路を選択
    editingPolyline=e.layer;
    // TODO: 各頂点にドラッグマーカー配置して折れ曲げ編集
  }
});

// ------------------- 路線作成 -------------------
document.getElementById('btnRouteMode').onclick=()=>{
  mode='route'; tempRouteStations=[];
  document.querySelectorAll('#routeTab .btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('btnRouteMode').classList.add('active');
};
document.getElementById('btnRouteRegister').onclick=()=>{
  if(tempRouteStations.length<2){alert('駅2つ以上'); return;}
  const id=Company.nextRouteId++;
  const color=document.getElementById('routeColor').value;
  const latlngs=tempRouteStations.map(s=>s.latlng);
  const poly=L.polyline(latlngs,{color,weight:5,opacity:0.9}).addTo(trackLayer);
  Company.routes.push({id,name:document.getElementById('routeName').value||`Route#${id}`,stations:tempRouteStations.map(s=>s.id),polyline:poly});
  tempRouteStations=[];
  document.getElementById('btnRouteRegister').disabled=true;
  updateHUD();
  animateVehicle(poly); // 簡易車両アニメ
};

// ------------------- 駅クリック（路線作成用） -------------------
function onStationClick(id){
  if(mode==='route'){
    const st=Company.stations[id];
    tempRouteStations.push(st);
    document.getElementById('btnRouteRegister').disabled=false;
  }
}

// ------------------- 車両アニメ -------------------
function animateVehicle(polyline){
  const vehicle=L.circleMarker(polyline.getLatLngs()[0],{radius:6,color:'red',fillColor:'red',fillOpacity:1}).addTo(vehicleLayer);
  let idx=0;
  function move(){
    const pts=polyline.getLatLngs();
    idx=(idx+1)%pts.length;
    vehicle.setLatLng(pts[idx]);
    setTimeout(move,500);
  }
  move();
}

// ------------------- 初期HUD -------------------
updateHUD();
</script>
</body>
</html>
