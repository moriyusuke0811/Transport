<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>交通会社経営ゲーム プロトタイプ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html,body,#map{height:100%;margin:0;padding:0;font-family:sans-serif;}
  #map{position:absolute;top:0;left:0;right:0;bottom:0;}
  .toolbox{position:absolute;left:10px;bottom:10px;background:rgba(255,255,255,0.95);padding:10px;border-radius:8px;z-index:1000;font-size:13px;}
  .btn{padding:5px 8px;margin:2px;cursor:pointer;border-radius:4px;background:#2c7dce;color:white;border:none;}
  .btn.selected{background:#ff8800;}
  .route-color{width:20px;height:20px;border:1px solid #000;display:inline-block;cursor:pointer;margin:2px;}
</style>
</head>
<body>
<div id="map"></div>

<div class="toolbox">
  <div>
    <button class="btn" id="btnStation">駅設置モード</button>
    <button class="btn" id="btnConnect">線路接続モード</button>
    <button class="btn" id="btnRoute">路線作成モード</button>
    <button class="btn" id="btnAddStationRoute">路線上駅追加</button>
  </div>
  <div style="margin-top:6px;">
    路線色:
    <div class="route-color" data-color="#2364a5" style="background:#2364a5"></div>
    <div class="route-color" data-color="#27ae60" style="background:#27ae60"></div>
    <div class="route-color" data-color="#e67e22" style="background:#e67e22"></div>
  </div>
  <div style="margin-top:6px;">
    <button class="btn" id="btnConfirmRoute">路線登録</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-editable@1.2.0/dist/Leaflet.Editable.min.js"></script>
<script>
const map = L.map('map', {editable:true}).setView([35.681236, 139.767125], 10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);

let mode = null;
let selectedColor = '#2364a5';
let stations = [];
let routes = [];
let tempRouteStations = [];
let tempRouteLine = null;
let connectFirst = null;

// 駅設置
document.getElementById('btnStation').onclick = ()=>{
  mode='station';
  setButtonSelected('btnStation');
};
document.getElementById('btnConnect').onclick = ()=>{
  mode='connect';
  connectFirst = null;
  setButtonSelected('btnConnect');
};
document.getElementById('btnRoute').onclick = ()=>{
  mode='route';
  tempRouteStations=[];
  if(tempRouteLine) map.removeLayer(tempRouteLine);
  setButtonSelected('btnRoute');
};
document.getElementById('btnAddStationRoute').onclick = ()=>{
  mode='addStation';
  setButtonSelected('btnAddStationRoute');
};

// 路線色選択
document.querySelectorAll('.route-color').forEach(el=>{
  el.onclick = ()=>{
    selectedColor = el.dataset.color;
    document.querySelectorAll('.route-color').forEach(e=>e.style.border='1px solid #000');
    el.style.border='2px solid red';
  };
});

// 駅設置
map.on('click', (e)=>{
  if(mode==='station'){
    const marker = L.circleMarker(e.latlng,{radius:8,color:'#2c7dce',fillColor:'#2c7dce',fillOpacity:0.8}).addTo(map);
    marker.stationId = stations.length;
    marker.dragging = new L.Handler.MarkerDrag(marker);
    marker.dragging.enable();
    marker.on('click', ()=> handleStationClick(marker));
    stations.push(marker);
  }
});

// 駅クリック
function handleStationClick(st){
  if(mode==='connect'){
    if(!connectFirst){
      connectFirst = st;
      st.setStyle({color:'#ff8800',fillColor:'#ff8800'});
    }else{
      const line = L.polyline([connectFirst.getLatLng(), st.getLatLng()],{color:'#999',weight:5,opacity:0.7}).addTo(map);
      routes.push({line:line, stations:[connectFirst,st]});
      connectFirst.setStyle({color:'#2c7dce',fillColor:'#2c7dce'});
      connectFirst=null;
    }
  }else if(mode==='route'){
    tempRouteStations.push(st);
    st.setStyle({color:'#ff8800',fillColor:'#ff8800'});
    if(tempRouteLine) map.removeLayer(tempRouteLine);
    const latlngs = tempRouteStations.map(s=>s.getLatLng());
    tempRouteLine = L.polyline(latlngs,{color:selectedColor,weight:5,opacity:0.7}).addTo(map);
  }
}

// 路線登録
document.getElementById('btnConfirmRoute').onclick = ()=>{
  if(tempRouteStations.length<2) return alert('2駅以上選択してください');
  const latlngs = tempRouteStations.map(s=>s.getLatLng());
  const line = L.polyline(latlngs,{color:selectedColor,weight:5,opacity:0.9}).addTo(map);
  line.editing.enable();
  line.stations = tempRouteStations.slice();
  line.on('click', addStationOnRoute);
  routes.push({line:line, stations:tempRouteStations.slice()});
  tempRouteStations.forEach(s=>s.setStyle({color:'#2c7dce',fillColor:'#2c7dce'}));
  tempRouteStations=[];
  if(tempRouteLine){ map.removeLayer(tempRouteLine); tempRouteLine=null; }
  alert('路線登録完了');
};

// 路線上駅追加
function addStationOnRoute(e){
  if(mode!=='addStation') return;
  const line = e.target;
  const nearest = findNearestPointOnLine(line, e.latlng);
  const marker = L.circleMarker(nearest,{radius:8,color:'#2c7dce',fillColor:'#2c7dce',fillOpacity:0.8}).addTo(map);
  marker.stationId = stations.length;
  marker.dragging = new L.Handler.MarkerDrag(marker);
  marker.dragging.enable();
  marker.on('click', ()=> handleStationClick(marker));
  stations.push(marker);
  line.addLatLng(nearest);
  line.stations.push(marker);
}

// 線上最近点
function findNearestPointOnLine(line, latlng){
  const pts = line.getLatLngs();
  let nearest = pts[0], minDist = map.distance(latlng, pts[0]);
  pts.forEach(pt=>{
    const d = map.distance(latlng, pt);
    if(d<minDist){ minDist=d; nearest=pt; }
  });
  return nearest;
}

// ボタン色選択表示
function setButtonSelected(id){
  document.querySelectorAll('.btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById(id).classList.add('selected');
}

</script>
</body>
</html>
