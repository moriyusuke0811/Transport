<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YMS Transit — 路線構築版</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background-color: #0d1117;
      font-family: "Segoe UI", sans-serif;
      color: #e6edf3;
    }

    #map {
      height: 100%;
      width: 100%;
      filter: brightness(0.85) saturate(0.8);
    }

    .hud {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(25,25,25,0.8);
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
      width: 200px;
    }

    .hud .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .toolbox {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(25,25,25,0.85);
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
    }

    .btn {
      background-color: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      margin: 2px;
      transition: 0.2s;
    }

    .btn.active {
      background-color: #2c7dce;
      box-shadow: 0 0 6px #5aa0f0;
    }

    .infoBox {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 13px;
      z-index: 1000;
    }

    .station-marker {
      background: #5aa0f0;
      border: 2px solid white;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      opacity: 0.9;
    }

    .station-marker.selected {
      background: #ffcc00;
      border-color: #fff;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="hud">
    <h3>会社ダッシュボード</h3>
    <div class="row"><div>会社名</div><div>YMS Transit</div></div>
    <div class="row"><div>駅数</div><div id="stationCount">0</div></div>
    <div class="row"><div>路線数</div><div id="routeCount">0</div></div>
  </div>

  <div class="infoBox" id="infoBox">東京全域マップ — 下メニューで操作</div>

  <div class="toolbox">
    <button class="btn" id="btnPlaceStation">駅設置</button>
    <button class="btn" id="btnCreateRoute">路線作成</button>
    <button class="btn" id="btnRegisterRoute">路線登録</button>
  </div>

  <script>
    const map = L.map('map', { zoomControl: false }).setView([35.681236, 139.767125], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let stations = [];
    let routes = [];
    let mode = null;
    let selectedStations = [];
    let tempLines = [];

    const infoBox = document.getElementById("infoBox");

    // --- ボタンアクティブ管理 ---
    const buttons = document.querySelectorAll(".btn");
    function setActiveButton(activeId) {
      buttons.forEach(btn => {
        if (btn.id === activeId) btn.classList.add("active");
        else btn.classList.remove("active");
      });
    }

    // --- 駅設置モード ---
    document.getElementById("btnPlaceStation").addEventListener("click", () => {
      mode = (mode === "station") ? null : "station";
      setActiveButton(mode === "station" ? "btnPlaceStation" : null);
      infoBox.textContent = mode ? "駅設置モード：クリックで駅を配置" : "東京全域マップ — 下メニューで操作";
    });

    // --- 路線作成モード ---
    document.getElementById("btnCreateRoute").addEventListener("click", () => {
      mode = (mode === "route") ? null : "route";
      setActiveButton(mode === "route" ? "btnCreateRoute" : null);
      selectedStations = [];
      clearTempLines();
      infoBox.textContent = mode ? "路線作成モード：駅を順にクリックでルート指定" : "東京全域マップ — 下メニューで操作";
    });

    // --- 路線登録 ---
    document.getElementById("btnRegisterRoute").addEventListener("click", () => {
      if (selectedStations.length < 2) {
        alert("最低2駅を選んでください。");
        return;
      }
      const name = prompt("路線名を入力：");
      if (!name) return;

      const route = {
        id: routes.length + 1,
        name,
        stations: selectedStations.map(s => s.id)
      };
      routes.push(route);

      document.getElementById("routeCount").textContent = routes.length;
      alert(`路線「${name}」を登録しました！`);

      selectedStations.forEach(s => s.marker._icon.classList.remove("selected"));
      selectedStations = [];
      clearTempLines();
      mode = null;
      setActiveButton(null);
      infoBox.textContent = "東京全域マップ — 下メニューで操作";
    });

    // --- 駅設置 ---
    map.on("click", (e) => {
      if (mode === "station") {
        const divIcon = L.divIcon({
          className: "station-marker",
          iconSize: [14, 14]
        });
        const marker = L.marker(e.latlng, { icon: divIcon, draggable: true }).addTo(map);
        const name = `駅${stations.length + 1}`;
        marker.bindTooltip(name, { permanent: true, direction: "top", offset: [0, -10] }).openTooltip();

        const stationObj = { id: stations.length + 1, name, marker };
        stations.push(stationObj);

        marker.on("click", (ev) => onStationClick(stationObj));
        marker.on("drag", (ev) => updateLines());
        document.getElementById("stationCount").textContent = stations.length;
      }
    });

    // --- 駅クリック時 ---
    function onStationClick(station) {
      if (mode === "route") {
        if (!selectedStations.includes(station)) {
          selectedStations.push(station);
          station.marker._icon.classList.add("selected");
          updateTempLines();
        } else {
          // 再クリックで削除
          selectedStations = selectedStations.filter(s => s !== station);
          station.marker._icon.classList.remove("selected");
          updateTempLines();
        }
      }
    }

    // --- 仮ルート描画 ---
    function updateTempLines() {
      clearTempLines();
      for (let i = 0; i < selectedStations.length - 1; i++) {
        const a = selectedStations[i].marker.getLatLng();
        const b = selectedStations[i + 1].marker.getLatLng();
        const line = L.polyline([a, b], { color: "cyan", weight: 4, opacity: 0.8 }).addTo(map);
        tempLines.push(line);
      }
    }

    function updateLines() {
      if (mode === "route") updateTempLines();
    }

    function clearTempLines() {
      tempLines.forEach(line => map.removeLayer(line));
      tempLines = [];
    }
  </script>
</body>
</html>
