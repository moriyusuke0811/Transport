<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YMS Transit Prototype</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background-color: #0d1117;
      color: #e6edf3;
      font-family: "Segoe UI", sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .hud {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(25,25,25,0.8);
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
      width: 200px;
    }
    .hud h3 {
      font-size: 14px;
      margin: 0 0 6px 0;
    }
    .hud .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }
    .hud .mini {
      font-size: 11px;
      color: #aaa;
    }
    .infoBox {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 13px;
      z-index: 1000;
    }
    .toolbox {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(25,25,25,0.85);
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
    }
    .btn {
      background-color: #2c7dce;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      margin: 2px;
    }
    .btn.secondary {
      background-color: #444;
    }
    .small {
      font-size: 11px;
      color: #aaa;
      margin-top: 4px;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- HUD（右上） -->
  <div class="hud" id="hud">
    <h3>会社ダッシュボード</h3>
    <div class="row"><div>会社名</div><div id="compName">YMS Transit</div></div>
    <div class="row"><div>資金</div><div id="funds">¥0</div></div>
    <div class="row"><div>時間</div><div id="time">Day 0 00:00</div></div>
    <div class="row"><div>収支（/分）</div><div id="cashflow">¥0</div></div>
    <div class="row"><div>路線数</div><div id="routeCount">0</div></div>
    <div class="row"><div>駅数</div><div id="stationCount">0</div></div>
    <div style="margin-top:8px" class="mini">※プロトタイプ：実データは後で導入</div>
  </div>

  <!-- インフォメーション（中央上） -->
  <div class="infoBox" id="infoBox">東京全域マップ — 左下で操作</div>

  <!-- 操作ツール（左下） -->
  <div class="toolbox" id="toolbox">
    <div>
      <button class="btn" id="btnPlaceStation">駅設置モード</button>
      <button class="btn secondary" id="btnConnect">線路接続モード</button>
    </div>
    <div style="margin-top:8px">
      <button class="btn" id="btnAddVehicle">車両追加</button>
      <button class="btn secondary" id="btnBuildCom">商業建設</button>
    </div>

    <div style="margin-top:8px">
      <button class="btn" id="btnPlayPause">⏸ 再生</button>
      <button class="btn secondary" id="btnSpeed">速度 x1</button>
    </div>

    <div style="margin-top:8px">
      <button class="btn" id="createRouteBtn">路線作成モード</button>
      <button class="btn secondary" id="saveRouteBtn">路線登録</button>
    </div>

    <div class="small">・駅設置：マップ上クリックで駅を置く（設置費用あり）</div>
    <div class="small">・線路接続：駅をクリックして選択 → 2つ目で接続</div>
  </div>

  <script>
    // マップ初期化
    const map = L.map('map').setView([35.681236, 139.767125], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    // ===== 駅設置関連 =====
    let isPlacingStation = false;
    let stationCount = 0;
    const stations = [];

    document.getElementById("btnPlaceStation").addEventListener("click", () => {
      isPlacingStation = !isPlacingStation;
      document.getElementById("infoBox").innerText = isPlacingStation
        ? "駅設置モード：マップ上をクリックしてください。"
        : "東京全域マップ — 左下で操作";
    });

    map.on("click", function(e) {
      if (isPlacingStation) {
        const marker = L.marker(e.latlng, { draggable: false }).addTo(map);
        marker.bindTooltip(`駅${stationCount + 1}`, { permanent: true, direction: 'top' }).openTooltip();
        marker.on("click", onStationClick); // 路線モードでも使えるよう登録
        stations.push(marker);
        stationCount++;
        document.getElementById("stationCount").innerText = stationCount;
      }
    });

    // ===== 路線作成関連 =====
    let isCreatingRoute = false;
    let tempRouteStations = [];
    let tempRouteLine = null;
    const routes = [];

    document.getElementById('createRouteBtn').addEventListener('click', () => {
      isCreatingRoute = !isCreatingRoute;
      tempRouteStations = [];
      if (tempRouteLine) {
        map.removeLayer(tempRouteLine);
        tempRouteLine = null;
      }

      if (isCreatingRoute) {
        document.getElementById("infoBox").innerText = "路線作成モード：駅を順にクリックしてください。";
      } else {
        document.getElementById("infoBox").innerText = "東京全域マップ — 左下で操作";
      }
    });

    function onStationClick(e) {
      if (!isCreatingRoute) return;

      const clickedStation = e.target;
      tempRouteStations.push(clickedStation.getLatLng());

      if (tempRouteStations.length > 1) {
        if (tempRouteLine) map.removeLayer(tempRouteLine);
        tempRouteLine = L.polyline(tempRouteStations, { color: 'cyan', weight: 4 }).addTo(map);
      }
    }

    document.getElementById('saveRouteBtn').addEventListener('click', () => {
      if (tempRouteStations.length < 2) {
        alert("駅を2つ以上選んでください。");
        return;
      }

      const routeName = prompt("路線名を入力してください：");
      if (!routeName) return;

      routes.push({
        name: routeName,
        stations: tempRouteStations.map(pos => ({ lat: pos.lat, lng: pos.lng }))
      });

      document.getElementById("routeCount").innerText = routes.length;
      alert(`「${routeName}」を登録しました！`);

      isCreatingRoute = false;
      tempRouteStations = [];
      tempRouteLine = null;
      document.getElementById("infoBox").innerText = "東京全域マップ — 左下で操作";
    });
  </script>
</body>
</html>
