<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>鉄道建設モード改良UI</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{
  margin:0;
  background:#0f1013;
  color:#e0e0e0;
  font-family:"Noto Sans JP",sans-serif;
}
#map{width:100%;height:calc(100vh - 80px);filter:brightness(0.9) contrast(0.9) saturate(0.8);}

/* 上部メニューバー */
.menu-bar{
  display:flex;
  background:#1b1c20;
  height:40px;
  align-items:center;
  border-bottom:1px solid #333;
}
.menu-btn{
  flex:1;
  height:100%;
  border:none;
  background:none;
  color:#aaa;
  font-weight:700;
  cursor:pointer;
  transition:0.2s;
}
.menu-btn.active{
  background:#2c7dce;
  color:#fff;
}

/* 建設操作バー（下段） */
.action-bar{
  display:none;
  align-items:center;
  justify-content:center;
  background:#22242a;
  height:40px;
  gap:10px;
  border-bottom:1px solid #444;
}
.action-bar.show{display:flex;}
.action-btn{
  border:none;
  background:#2c7dce;
  color:white;
  font-weight:700;
  border-radius:6px;
  cursor:pointer;
  padding:6px 12px;
}
.action-btn.cancel{background:#ff6b6b;}
.action-btn.undo{background:#6c757d;}
.action-btn.confirm{background:#27ae60;}

/* 資金表示 */
#hud{
  position:absolute;
  top:12px;
  right:12px;
  background:rgba(255,255,255,0.08);
  padding:8px 14px;
  border-radius:8px;
  font-size:14px;
  backdrop-filter:blur(8px);
}
</style>
</head>
<body>

<!-- メニューバー -->
<div class="menu-bar">
  <button class="menu-btn active" onclick="setMode('select')">選択モード</button>
  <button class="menu-btn" onclick="setMode('station')">駅建設</button>
  <button class="menu-btn" onclick="setMode('track')">線路建設</button>
  <button class="menu-btn" onclick="setMode('route')">路線設定</button>
</div>

<!-- 建設時のみ表示される操作バー -->
<div id="actionBar" class="action-bar">
  <button class="action-btn undo" onclick="undoTemp()">↺ 一つ戻る</button>
  <button class="action-btn cancel" onclick="cancelTemp()">✖ キャンセル</button>
  <button class="action-btn confirm" onclick="confirmTemp()">✔ 確定</button>
</div>

<!-- 地図 -->
<div id="map"></div>

<!-- HUD -->
<div id="hud">資金: <span id="funds">¥1,000,000</span></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([35.6812,139.7671],13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);

let mode='select'; // 現在モード
let tempTrackPoints=[];
let tempStation=null;
let funds=1000000;
const DB={stations:{},tracks:{}};
let nextStationId=1,nextTrackId=1;
const tempLayers=[];

function setMode(newMode){
  mode=newMode;
  document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`[onclick="setMode('${newMode}')"]`).classList.add('active');
  const bar=document.getElementById('actionBar');
  if(newMode==='station' || newMode==='track'){ bar.classList.add('show'); }
  else{ bar.classList.remove('show'); }
}

map.on('click', e=>{
  if(mode==='station') placeTempStation(e.latlng);
  if(mode==='track') addTrackNode(e.latlng);
  if(mode==='select') selectObject(e.latlng);
});

function formatYen(n){return '¥'+n.toLocaleString();}

function updateFunds(){
  document.getElementById('funds').textContent=formatYen(funds);
}

/*--------------------------
  駅建設
---------------------------*/
function placeTempStation(latlng){
  if(tempStation) map.removeLayer(tempStation.marker);
  tempStation={latlng,marker:L.circleMarker(latlng,{radius:6,color:'#facc15'}).addTo(map)};
}

/*--------------------------
  線路仮設
---------------------------*/
function addTrackNode(latlng){
  tempTrackPoints.push(latlng);
  const p=L.circleMarker(latlng,{radius:4,color:'#5aa0f0'}).addTo(map);
  tempLayers.push(p);
  if(tempTrackPoints.length>1){
    const l=L.polyline([tempTrackPoints[tempTrackPoints.length-2],latlng],
      {color:'#2c7dce',weight:3,opacity:0.6,dashArray:'6,6'}).addTo(map);
    tempLayers.push(l);
  }
}

function undoTemp(){
  if(mode==='track' && tempTrackPoints.length>0){
    tempTrackPoints.pop();
    const last=tempLayers.pop();
    if(last) map.removeLayer(last);
  }
  if(mode==='station' && tempStation){
    map.removeLayer(tempStation.marker);
    tempStation=null;
  }
}

function cancelTemp(){
  tempTrackPoints=[];
  tempLayers.forEach(l=>map.removeLayer(l));
  tempLayers.length=0;
  if(tempStation){map.removeLayer(tempStation.marker);tempStation=null;}
}

/*--------------------------
  確定処理
---------------------------*/
function confirmTemp(){
  if(mode==='station' && tempStation){
    const id='S'+nextStationId++;
    const marker=L.circleMarker(tempStation.latlng,{radius:8,color:'#2c7dce',fillColor:'#2c7dce',fillOpacity:1})
      .addTo(map).bindPopup(`<strong>駅 ${id}</strong><br>建設費 ¥50,000`);
    DB.stations[id]={id,latlng:tempStation.latlng,marker};
    funds-=50000;updateFunds();
    map.removeLayer(tempStation.marker);
    tempStation=null;
  }
  if(mode==='track' && tempTrackPoints.length>1){
    for(let i=0;i<tempTrackPoints.length-1;i++){
      const id='T'+nextTrackId++;
      const line=L.polyline([tempTrackPoints[i],tempTrackPoints[i+1]],{color:'#2c7dce',weight:4}).addTo(map);
      DB.tracks[id]={id,line};
    }
    funds-=tempTrackPoints.length*10000;updateFunds();
    cancelTemp();
  }
}

/*--------------------------
  選択モード
---------------------------*/
function selectObject(latlng){
  // 駅判定
  let found=null,min=80;
  for(const s of Object.values(DB.stations)){
    const d=map.distance(latlng,s.latlng);
    if(d<min){min=d;found=s;}
  }
  if(found){
    found.marker.openPopup();
    return;
  }
  // 線路判定（近い点があれば情報表示）
  for(const t of Object.values(DB.tracks)){
    const ll=t.line.getLatLngs();
    for(let i=0;i<ll.length-1;i++){
      const mid=L.latLng((ll[i].lat+ll[i+1].lat)/2,(ll[i].lng+ll[i+1].lng)/2);
      if(map.distance(latlng,mid)<40){
        L.popup().setLatLng(latlng).setContent(`<strong>線路 ${t.id}</strong><br>区間情報: ${ll.length-1} 本`).openOn(map);
        return;
      }
    }
  }
}

updateFunds();
</script>
</body>
</html>
