<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>é‰„é“å»ºè¨­ã‚·ã‚¹ãƒ†ãƒ  v3</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{
  margin:0;
  font-family:"Noto Sans JP",sans-serif;
  background:#0f1113;
  color:#eaeaea;
}
#map{width:100%;height:calc(100vh - 120px);}

/* ===== ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ===== */
.menu-bar{
  display:flex;
  background:#1b1c20;
  height:40px;
  align-items:center;
  border-bottom:1px solid #333;
}
.menu-btn{
  flex:1;
  height:100%;
  border:none;
  background:none;
  color:#aaa;
  font-weight:700;
  cursor:pointer;
  transition:0.2s;
}
.menu-btn.active{
  background:#2c7dce;
  color:#fff;
}

/* ===== å»ºè¨­ã‚«ãƒ†ã‚´ãƒªãƒãƒ¼ ===== */
.build-bar{
  display:none;
  background:#22242a;
  height:40px;
  align-items:center;
  justify-content:center;
  border-bottom:1px solid #444;
}
.build-bar.show{display:flex;}
.build-btn{
  margin:0 10px;
  padding:6px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  background:#333;
  color:#aaa;
}
.build-btn.active{
  background:#2c7dce;
  color:white;
}

/* ===== å»ºè¨­æ“ä½œãƒãƒ¼ ===== */
.action-bar{
  display:none;
  background:#25272e;
  height:40px;
  align-items:center;
  justify-content:center;
  gap:10px;
  border-bottom:1px solid #444;
}
.action-bar.show{display:flex;}
.action-btn{
  border:none;
  border-radius:6px;
  font-weight:700;
  padding:6px 12px;
  cursor:pointer;
}
.action-btn.undo{background:#6c757d;color:white;}
.action-btn.cancel{background:#ff6b6b;color:white;}
.action-btn.confirm{background:#27ae60;color:white;}

/* ===== HUDãƒ»UIè£œåŠ© ===== */
#hud{
  position:absolute;
  top:10px;
  right:10px;
  background:rgba(255,255,255,0.1);
  padding:6px 10px;
  border-radius:8px;
  font-size:14px;
  backdrop-filter:blur(6px);
}
#selectModeBtn{
  position:absolute;
  bottom:20px;
  right:20px;
  background:#2c7dce;
  color:white;
  border:none;
  border-radius:50%;
  width:48px;
  height:48px;
  font-size:22px;
  font-weight:bold;
  cursor:pointer;
  box-shadow:0 2px 10px rgba(0,0,0,0.4);
}
</style>
</head>
<body>

<!-- ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ -->
<div class="menu-bar">
  <button class="menu-btn active" onclick="switchMainTab('build')">å»ºè¨­</button>
  <button class="menu-btn" onclick="switchMainTab('route')">è·¯ç·šè¨­å®š</button>
</div>

<!-- å»ºè¨­ã‚«ãƒ†ã‚´ãƒªãƒãƒ¼ -->
<div id="buildBar" class="build-bar">
  <button class="build-btn" onclick="setBuildType('station')">é§…</button>
  <button class="build-btn" onclick="setBuildType('track')">ç·šè·¯</button>
  <button class="build-btn" onclick="setBuildType('facility')">æ–½è¨­</button>
  <button class="build-btn" onclick="setBuildType('shop')">åº—èˆ—</button>
</div>

<!-- æ“ä½œãƒãƒ¼ -->
<div id="actionBar" class="action-bar">
  <button class="action-btn undo" onclick="undoTemp()">â†º ä¸€ã¤æˆ»ã‚‹</button>
  <button class="action-btn cancel" onclick="cancelTemp()">âœ– ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  <button class="action-btn confirm" onclick="confirmTemp()">âœ” ç¢ºå®š</button>
</div>

<!-- åœ°å›³ -->
<div id="map"></div>

<!-- HUD -->
<div id="hud">è³‡é‡‘: <span id="funds">Â¥1,000,000</span></div>

<!-- é¸æŠãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ -->
<button id="selectModeBtn" title="é¸æŠãƒ¢ãƒ¼ãƒ‰" onclick="enterSelectMode()">ğŸ–±</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map=L.map('map').setView([35.6812,139.7671],13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);

let mainTab='build';
let buildType=null;
let mode='select';
let tempPoints=[];
let funds=1000000;
const DB={stations:[],tracks:[],facilities:[],shops:[]};
const tempLayers=[];

function formatYen(n){return 'Â¥'+n.toLocaleString();}
function updateFunds(){document.getElementById('funds').textContent=formatYen(funds);}

function switchMainTab(tab){
  mainTab=tab;
  document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`[onclick="switchMainTab('${tab}')"]`).classList.add('active');
  const buildBar=document.getElementById('buildBar');
  if(tab==='build') buildBar.classList.add('show');
  else buildBar.classList.remove('show');
  resetMode();
}

function resetMode(){
  mode='select';
  buildType=null;
  tempPoints=[];
  tempLayers.forEach(l=>map.removeLayer(l));
  tempLayers.length=0;
  document.querySelectorAll('.build-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('actionBar').classList.remove('show');
}

function setBuildType(type){
  buildType=type;
  mode='build';
  document.querySelectorAll('.build-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`[onclick="setBuildType('${type}')"]`).classList.add('active');
  document.getElementById('actionBar').classList.add('show');
}

function enterSelectMode(){
  resetMode();
  mode='select';
}

map.on('click',e=>{
  if(mode==='build' && buildType){
    if(buildType==='station') placeTempStation(e.latlng);
    if(buildType==='track') addTempTrack(e.latlng);
  } else if(mode==='select'){
    selectObject(e.latlng);
  }
});

/* ==== ä»®è¨­å‡¦ç† ==== */
function placeTempStation(latlng){
  cancelTemp();
  const m=L.circleMarker(latlng,{radius:6,color:'#facc15'}).addTo(map);
  tempLayers.push(m);
  tempPoints=[latlng];
}
function addTempTrack(latlng){
  tempPoints.push(latlng);
  const m=L.circleMarker(latlng,{radius:4,color:'#5aa0f0'}).addTo(map);
  tempLayers.push(m);
  if(tempPoints.length>1){
    const l=L.polyline([tempPoints[tempPoints.length-2],latlng],{color:'#2c7dce',weight:3,opacity:0.6,dashArray:'6,6'}).addTo(map);
    tempLayers.push(l);
  }
}
function undoTemp(){
  if(tempPoints.length>0){
    tempPoints.pop();
    const last=tempLayers.pop();
    if(last) map.removeLayer(last);
  }
}
function cancelTemp(){
  tempPoints=[];
  tempLayers.forEach(l=>map.removeLayer(l));
  tempLayers.length=0;
}

/* ==== ç¢ºå®š ==== */
function confirmTemp(){
  if(buildType==='station' && tempPoints.length){
    const s=L.circleMarker(tempPoints[0],{radius:8,color:'#2c7dce',fillColor:'#2c7dce',fillOpacity:1}).addTo(map)
      .bindPopup('é§…ï¼ˆæ’¤å»å¯ï¼‰');
    DB.stations.push(s);
    funds-=50000;updateFunds();
    cancelTemp();
  }
  if(buildType==='track' && tempPoints.length>1){
    const line=L.polyline(tempPoints,{color:'#2c7dce',weight:4}).addTo(map)
      .bindPopup('ç·šè·¯ï¼ˆæ’¤å»å¯ï¼‰');
    DB.tracks.push(line);
    funds-=tempPoints.length*10000;updateFunds();
    cancelTemp();
  }
}

/* ==== æ’¤å» ==== */
map.on('contextmenu',e=>{
  if(mode==='build'){
    let target=null;
    for(const s of DB.stations){
      if(map.distance(e.latlng,s.getLatLng())<50){target=s;break;}
    }
    if(target){map.removeLayer(target);DB.stations=DB.stations.filter(x=>x!==target);funds+=25000;updateFunds();return;}
    for(const t of DB.tracks){
      const ll=t.getLatLngs();
      for(let i=0;i<ll.length-1;i++){
        const mid=L.latLng((ll[i].lat+ll[i+1].lat)/2,(ll[i].lng+ll[i+1].lng)/2);
        if(map.distance(e.latlng,mid)<40){map.removeLayer(t);DB.tracks=DB.tracks.filter(x=>x!==t);funds+=5000;updateFunds();return;}
      }
    }
  }
});

/* ==== é¸æŠãƒ¢ãƒ¼ãƒ‰ ==== */
function selectObject(latlng){
  let found=null,min=80;
  for(const s of DB.stations){
    const d=map.distance(latlng,s.getLatLng());
    if(d<min){min=d;found=s;}
  }
  if(found){found.openPopup();}
}

updateFunds();
</script>
</body>
</html>
