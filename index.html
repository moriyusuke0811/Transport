<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>鉄道シミュレーター</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      margin: 0;
      background: #0e0e11;
      color: #eee;
      font-family: "Segoe UI", sans-serif;
    }
    #map {
      width: 100%;
      height: 90vh;
    }
    .menu-bar {
      display: flex;
      background: #1b1b22;
      border-bottom: 2px solid #333;
    }
    .menu-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: #1b1b22;
      color: #aaa;
      cursor: pointer;
      transition: 0.2s;
      font-weight: bold;
    }
    .menu-btn.active {
      background: #2c7dce;
      color: #fff;
    }
    .panel {
      display: none;
      background: #1b1b22;
      padding: 8px;
    }
    .panel.active {
      display: block;
    }
    .button {
      background: #2c7dce;
      border: none;
      color: white;
      padding: 5px 12px;
      margin: 3px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
    }
    .button.active {
      background: #facc15;
      color: #000;
    }
    #budget {
      padding: 6px 10px;
      background: #111;
      color: #7ff;
      position: absolute;
      top: 10px;
      right: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="menu-bar">
    <button class="menu-btn active" onclick="showTab('construction')">建設メニュー</button>
    <button class="menu-btn" onclick="showTab('routes')">路線メニュー</button>
    <button class="menu-btn" onclick="showTab('vehicles')">車両メニュー</button>
    <button class="menu-btn" onclick="showTab('stats')">統計メニュー</button>
  </div>

  <!-- 各タブパネル -->
  <div id="construction" class="panel active">
    <button class="button" id="stationBtn" onclick="setMode('station')">駅設置</button>
    <button class="button" id="trackBtn" onclick="setMode('track')">線路敷設</button>
    <button class="button" id="confirmBtn" onclick="confirmPlacement()">確定</button>
    <span id="costPreview">必要金額: 0</span>
  </div>

  <div id="routes" class="panel">
    <button class="button" onclick="setMode('route')">路線作成</button>
    <button class="button" onclick="finalizeRoute()">路線確定</button>
  </div>

  <div id="vehicles" class="panel">
    <p>車両購入・割当メニュー（仮）</p>
  </div>

  <div id="stats" class="panel">
    <p>利用データ・収支グラフ（仮）</p>
  </div>

  <div id="map"></div>
  <div id="budget">資金: ¥<span id="budgetValue">1000000</span></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([35.6812,139.7671], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19,
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);

    const DB = {
      stations: {},
      tracks: {},
      routes: {}
    };
    let currentMode = null;
    let tempStation = null;
    let tempTrackPoints = [];
    let budget = 1000000;
    let nextStationId = 1;
    let nextTrackId = 1;
    let nextRouteId = 1;
    let tempRoute = [];

    function showTab(id){
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`[onclick="showTab('${id}')"]`).classList.add('active');
    }

    function setMode(mode){
      currentMode = mode;
      document.querySelectorAll('.button').forEach(b=>b.classList.remove('active'));
      if(mode==='station') document.getElementById('stationBtn').classList.add('active');
      if(mode==='track') document.getElementById('trackBtn').classList.add('active');
      if(mode==='route') alert('駅を順にクリックして路線登録します');
    }

    map.on('click', e=>{
      if(currentMode==='station') createTempStation(e.latlng);
      if(currentMode==='track') addTrackPoint(e.latlng);
      if(currentMode==='route') selectStationForRoute(e.latlng);
    });

    // 仮駅設置
    function createTempStation(latlng){
      if(tempStation) map.removeLayer(tempStation.marker);
      tempStation = {
        latlng,
        marker: L.circleMarker(latlng,{
          radius:5,
          color:'#facc15'
        }).addTo(map)
      };
      document.getElementById('costPreview').textContent = '必要金額: ¥50000';
    }

    // 線路仮設置
    function addTrackPoint(latlng){
      tempTrackPoints.push(latlng);
      L.circleMarker(latlng,{radius:4,color:'#5aa0f0'}).addTo(map);
      if(tempTrackPoints.length>1){
        L.polyline([tempTrackPoints[tempTrackPoints.length-2], latlng],
          {color:'#2c7dce',weight:2,dashArray:'4,4'}).addTo(map);
      }
      document.getElementById('costPreview').textContent = `必要金額: ¥${tempTrackPoints.length*10000}`;
    }

    function confirmPlacement(){
      if(currentMode==='station' && tempStation){
        const id = 'S'+nextStationId++;
        const marker = L.circleMarker(tempStation.latlng,{
          radius:8,
          color:'#2c7dce',
          fillColor:'#2c7dce',
          fillOpacity:1
        }).addTo(map).on('click',()=>onBuiltStationClick(id));
        DB.stations[id]={id,marker,latlng:tempStation.latlng};
        budget -= 50000;
        updateBudget();
        tempStation=null;
        document.getElementById('costPreview').textContent='必要金額: 0';
      }
      if(currentMode==='track' && tempTrackPoints.length>1){
        for(let i=0;i<tempTrackPoints.length-1;i++){
          const id='T'+nextTrackId++;
          const line=L.polyline([tempTrackPoints[i],tempTrackPoints[i+1]],{
            color:'#2c7dce',weight:3
          }).addTo(map);
          DB.tracks[id]={id,line,start:tempTrackPoints[i],end:tempTrackPoints[i+1]};
        }
        budget -= tempTrackPoints.length*10000;
        updateBudget();
        tempTrackPoints=[];
        document.getElementById('costPreview').textContent='必要金額: 0';
      }
    }

    function onBuiltStationClick(id){
      const s=DB.stations[id];
      if(currentMode==='route'){
        tempRoute.push(id);
        s.marker.setStyle({color:'#facc15'});
      }
      highlightConnectedTracks(id); // 接続線ハイライト追加！
    }

    function finalizeRoute(){
      if(tempRoute.length<2){alert('2駅以上選択してください');return;}
      const id='R'+nextRouteId++;
      DB.routes[id]={id,stations:[...tempRoute]};
      tempRoute.forEach(sid=>{
        DB.stations[sid].marker.setStyle({color:'#2c7dce'});
      });
      alert(`路線 ${id} を登録しました`);
      tempRoute=[];
    }

    function highlightConnectedTracks(stationId){
      Object.values(DB.tracks).forEach(t=>{
        if(t.line) t.line.setStyle({color:'#2c7dce',weight:3,opacity:0.8});
      });
      const connected=Object.values(DB.tracks).filter(t=>{
        return isNear(t.start,DB.stations[stationId].latlng)||isNear(t.end,DB.stations[stationId].latlng);
      });
      connected.forEach(t=>{
        if(t.line)t.line.setStyle({color:'#facc15',weight:6,opacity:1});
      });
      setTimeout(()=>{
        connected.forEach(t=>{
          if(t.line)t.line.setStyle({color:'#2c7dce',weight:3,opacity:0.8});
        });
      },2500);
    }

    function isNear(a,b){
      const dx=a.lat-b.lat,dy=a.lng-b.lng;
      return Math.sqrt(dx*dx+dy*dy)<0.0005;
    }

    function selectStationForRoute(latlng){
      let nearest=null,min=9999;
      for(const id in DB.stations){
        const s=DB.stations[id];
        const d=map.distance(latlng,s.latlng);
        if(d<100 && d<min){nearest=id;min=d;}
      }
      if(nearest) onBuiltStationClick(nearest);
    }

    function updateBudget(){
      document.getElementById('budgetValue').textContent = budget;
    }
  </script>
</body>
</html>
