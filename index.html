<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>交通会社経営ゲーム - 東京版</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background-color: #111;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
    }
    #map {
      height: 100%;
      filter: brightness(0.85) saturate(0.8);
    }
    .hud {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      border-radius: 8px;
      padding: 10px;
      font-size: 13px;
      min-width: 180px;
    }
    .row { display: flex; justify-content: space-between; }
    .toolbox {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      border-radius: 10px;
      padding: 10px;
      font-size: 13px;
    }
    .btn {
      background: #2c7dce;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      cursor: pointer;
      margin: 2px;
    }
    .btn.active { background: #5aa0f0; }
    .btn.secondary { background: #555; }
    .infoBox {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 14px;
    }
    .colorPicker {
      display: none;
      position: absolute;
      background: rgba(0,0,0,0.7);
      padding: 6px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="hud" id="hud">
    <h3>会社ダッシュボード</h3>
    <div class="row"><div>会社名</div><div id="compName">YMS Transit</div></div>
    <div class="row"><div>資金</div><div id="funds">¥1,000,000</div></div>
    <div class="row"><div>時間</div><div id="time">Day 0 00:00</div></div>
    <div class="row"><div>収支（/分）</div><div id="cashflow">¥0</div></div>
    <div class="row"><div>路線数</div><div id="routeCount">0</div></div>
    <div class="row"><div>駅数</div><div id="stationCount">0</div></div>
  </div>

  <div class="infoBox" id="infoBox">東京全域マップ — 左下で操作</div>

  <div class="toolbox" id="toolbox">
    <div>
      <button class="btn" id="btnPlaceStation">駅設置モード</button>
      <button class="btn" id="btnConnect">線路接続モード</button>
      <button class="btn" id="btnRoute">路線登録モード</button>
    </div>
    <div style="margin-top:8px">
      <button class="btn" id="btnAddVehicle">車両購入</button>
      <button class="btn" id="btnBuildCom">商業建設</button>
    </div>
  </div>

  <input type="color" id="routeColorPicker" class="colorPicker" />

  <script>
  const map = L.map('map').setView([35.68, 139.76], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);

  let mode = null;
  let stations = [];
  let lines = [];
  let currentConnection = [];
  let currentRoute = [];
  let routeColor = '#ff6600';

  const colorPicker = document.getElementById('routeColorPicker');

  function setMode(newMode, btn) {
    mode = newMode;
    document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    currentRoute = [];
    currentConnection = [];
    stations.forEach(s => s.setStyle({ color: '#5aa0f0', fillColor: '#5aa0f0' }));
  }

  document.getElementById('btnPlaceStation').onclick = e => setMode('station', e.target);
  document.getElementById('btnConnect').onclick = e => setMode('connect', e.target);
  document.getElementById('btnRoute').onclick = e => setMode('route', e.target);

  map.on('click', e => {
    if (mode === 'station') {
      const marker = L.circleMarker(e.latlng, { radius: 7, color: '#5aa0f0', fillColor: '#5aa0f0', fillOpacity: 0.8 }).addTo(map);
      marker.stationId = stations.length;
      marker.bindTooltip('駅 ' + (stations.length + 1));
      stations.push(marker);
      document.getElementById('stationCount').textContent = stations.length;

      marker.on('click', evt => handleStationClick(evt.target));
    }
  });

  function handleStationClick(station) {
    if (mode === 'connect') {
      currentConnection.push(station);
      station.setStyle({ color: '#ffaa00', fillColor: '#ffaa00' });
      if (currentConnection.length === 2) {
        const line = L.polyline(
          [currentConnection[0].getLatLng(), currentConnection[1].getLatLng()],
          { color: '#888', weight: 4 }
        ).addTo(map);
        lines.push(line);
        currentConnection.forEach(s => s.setStyle({ color: '#5aa0f0', fillColor: '#5aa0f0' }));
        currentConnection = [];
      }
    }

    if (mode === 'route') {
      station.setStyle({ color: '#ff8800', fillColor: '#ff8800' });
      currentRoute.push(station.getLatLng());
    }
  }

  // 路線確定ボタン
  const confirmBtn = document.createElement('button');
  confirmBtn.textContent = '路線を確定';
  confirmBtn.className = 'btn';
  confirmBtn.style.marginTop = '8px';
  document.querySelector('.toolbox').appendChild(confirmBtn);

  confirmBtn.onclick = () => {
    if (mode === 'route' && currentRoute.length >= 2) {
      colorPicker.style.display = 'block';
      colorPicker.style.left = '160px';
      colorPicker.style.top = '80px';
      colorPicker.onchange = () => {
        routeColor = colorPicker.value;
        const routeLine = L.polyline(currentRoute, { color: routeColor, weight: 5 }).addTo(map);
        const routeName = prompt('路線名を入力してください:', '新路線');
        if (routeName) routeLine.bindTooltip(routeName);
        let count = parseInt(document.getElementById('routeCount').textContent);
        document.getElementById('routeCount').textContent = count + 1;
        currentRoute = [];
        colorPicker.style.display = 'none';
        stations.forEach(s => s.setStyle({ color: '#5aa0f0', fillColor: '#5aa0f0' }));
      };
    } else {
      alert('2つ以上の駅を選んでください');
    }
  };
</script>

</body>
</html>
