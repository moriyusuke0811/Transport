<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>交通会社経営ゲーム プロトタイプ（東京全域）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html,body,#map{height:100%;margin:0;padding:0;font-family:"Noto Sans JP",Arial,sans-serif;}
  #map{position:absolute;left:0;top:0;right:0;bottom:0;}
  .hud{position:absolute;right:16px;top:16px;width:240px;background:rgba(255,255,255,0.94);border-radius:10px;padding:10px;box-shadow:0 6px 18px rgba(0,0,0,0.12);font-size:13px;z-index:1000;}
  .toolbox{position:absolute;left:18px;bottom:18px;background:rgba(255,255,255,0.96);border-radius:12px;padding:10px;width:220px;box-shadow:0 8px 20px rgba(0,0,0,0.12);font-size:13px;z-index:1000;}
  .infoBox{position:absolute;left:50%;top:8px;transform:translateX(-50%);background:rgba(255,255,255,0.9);padding:6px 10px;border-radius:8px;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:1000;}
  .btn{padding:4px 6px;margin:2px;border-radius:5px;background:#2c7dce;color:white;border:none;cursor:pointer;font-size:12px;}
  .btn.secondary{background:#6c757d;}
  .small{font-size:12px;color:#333;}
  .station-icon div{width:16px;height:16px;background:#2c7dce;border-radius:50%;border:2px solid white;box-shadow:0 0 3px rgba(0,0,0,0.5);}
</style>
</head>
<body>
<div id="map"></div>

<div class="hud" id="hud">
  <h3>会社ダッシュボード</h3>
  <div>資金: <span id="funds">¥10000000</span></div>
  <div>駅数: <span id="stationCount">0</span></div>
  <div>路線数: <span id="routeCount">0</span></div>
</div>

<div class="infoBox" id="infoBox">東京全域マップ</div>

<div class="toolbox">
  <button class="btn" id="btnStation">駅設置モード</button>
  <button class="btn secondary" id="btnRoute">路線作成モード</button>
  <button class="btn" id="btnRegister">路線登録</button>
  <select id="routeColor" style="margin-top:4px;width:100%;"><option value="#2364a5">青</option><option value="#e67e22">オレンジ</option><option value="#27ae60">緑</option></select>
  <div id="routeInfo" class="small">選択駅: なし</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([35.681236,139.767125], 10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; OpenStreetMap contributors & CartoDB',
  maxZoom:19
}).addTo(map);

let stations=[], routes=[];
let mode = null;
let tempRouteStations = [], tempRouteLine = null;

// HUD更新
function updateHUD(){
  document.getElementById('stationCount').innerText = stations.length;
  document.getElementById('routeCount').innerText = routes.length;
  if(tempRouteStations.length){
    document.getElementById('routeInfo').innerText='選択駅: '+tempRouteStations.map(s=>s.id).join(' → ');
    document.getElementById('btnRegister').disabled=false;
  } else {
    document.getElementById('routeInfo').innerText='選択駅: なし';
    document.getElementById('btnRegister').disabled=true;
  }
}

// 駅設置モードボタン
document.getElementById('btnStation').onclick = ()=>{
  mode='station';
  map.getContainer().style.cursor='crosshair';
  tempRouteStations=[];
  if(tempRouteLine){ map.removeLayer(tempRouteLine); tempRouteLine=null; }
  updateHUD();
};

// 路線作成モードボタン
document.getElementById('btnRoute').onclick = ()=>{
  mode='route';
  tempRouteStations=[];
  if(tempRouteLine){ map.removeLayer(tempRouteLine); tempRouteLine=null; }
  map.getContainer().style.cursor='pointer';
  updateHUD();
};

// 路線登録
document.getElementById('btnRegister').onclick = ()=>{
  if(tempRouteStations.length<2) return alert('駅を2つ以上選択してください');
  const color = document.getElementById('routeColor').value;
  const latlngs = tempRouteStations.map(s=>s.marker.getLatLng());
  const poly = L.polyline(latlngs,{color:color,weight:5}).addTo(map);
  routes.push({stations:tempRouteStations.map(s=>s.id),polyline:poly,color:color});
  tempRouteStations=[];
  if(tempRouteLine){ map.removeLayer(tempRouteLine); tempRouteLine=null; }
  updateHUD();
};

// 駅設置
map.on('click',(e)=>{
  if(mode==='station'){
    const marker = L.marker(e.latlng,{
      draggable:true,
      icon:L.divIcon({className:'station-icon',html:'<div></div>',iconSize:[16,16],iconAnchor:[8,8]})
    }).addTo(map);
    marker.stationId=stations.length+1;
    marker.on('click',()=> handleStationClick(marker));
    stations.push({id:marker.stationId, marker:marker});
    updateHUD();
  }
});

// 駅クリック
function handleStationClick(marker){
  if(mode==='route'){
    if(!tempRouteStations.find(s=>s.id===marker.stationId)){
      tempRouteStations.push({id:marker.stationId, marker:marker});
      if(tempRouteLine) map.removeLayer(tempRouteLine);
      const latlngs = tempRouteStations.map(s=>s.marker.getLatLng());
      tempRouteLine = L.polyline(latlngs,{color:'#888',weight:3,opacity:0.5,dashArray:'5,5'}).addTo(map);
      updateHUD();
    }
  }
}

// 初期サンプル駅
const samplePoints=[
  [35.6895,139.6917],[35.681236,139.767125],[35.658034,139.701636]
];
samplePoints.forEach((p,i)=>{
  const marker = L.marker(p,{draggable:true,icon:L.divIcon({className:'station-icon',html:'<div></div>',iconSize:[16,16],iconAnchor:[8,8]})}).addTo(map);
  marker.stationId=i+1;
  marker.on('click',()=>handleStationClick(marker));
  stations.push({id:marker.stationId,marker:marker});
});
updateHUD();
</script>
</body>
</html>
