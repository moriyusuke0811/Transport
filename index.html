<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YMS Transit — Prototype v3</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background-color: #0d1117;
      font-family: "Segoe UI", sans-serif;
      color: #e6edf3;
    }

    #map {
      height: 100%;
      width: 100%;
      filter: brightness(0.85) saturate(0.8); /* 彩度を落として全体を落ち着かせる */
    }

    .hud {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(25,25,25,0.8);
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
      width: 200px;
    }

    .hud .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .toolbox {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(25,25,25,0.85);
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
    }

    .btn {
      background-color: #2c7dce;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      margin: 2px;
    }

    .btn.secondary {
      background-color: #444;
    }

    .infoBox {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 13px;
      z-index: 1000;
    }

    .station-marker {
      background: #5aa0f0;
      border: 2px solid white;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      opacity: 0.9;
    }

    .station-marker.selected {
      background: #ffcc00;
      border-color: #fff;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="hud">
    <h3>会社ダッシュボード</h3>
    <div class="row"><div>会社名</div><div>YMS Transit</div></div>
    <div class="row"><div>駅数</div><div id="stationCount">0</div></div>
    <div class="row"><div>線路数</div><div id="trackCount">0</div></div>
    <div class="row"><div>路線数</div><div id="routeCount">0</div></div>
  </div>

  <div class="infoBox" id="infoBox">東京全域マップ — 左下で操作</div>

  <div class="toolbox">
    <button class="btn" id="btnPlaceStation">駅設置モード</button>
    <button class="btn secondary" id="btnConnect">線路接続モード</button>
    <button class="btn secondary" id="btnCreateRoute">路線作成モード</button>
    <button class="btn" id="btnRegisterRoute">路線登録</button>
  </div>

  <script>
    const map = L.map('map', { zoomControl: false }).setView([35.681236, 139.767125], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // ===== データ =====
    let stations = [];
    let tracks = [];
    let routes = [];

    // ===== 状態 =====
    let mode = null;
    let selectedStations = [];
    let selectedTracks = [];
    let tempLine = null;

    const infoBox = document.getElementById("infoBox");

    // ===== 駅設置 =====
    document.getElementById("btnPlaceStation").addEventListener("click", () => {
      mode = (mode === "station") ? null : "station";
      infoBox.textContent = mode ? "駅設置モード：クリックで駅を設置" : "東京全域マップ — 左下で操作";
    });

    map.on("click", (e) => {
      if (mode === "station") {
        const divIcon = L.divIcon({
          className: "station-marker",
          iconSize: [14, 14]
        });
        const marker = L.marker(e.latlng, { icon: divIcon }).addTo(map);
        const name = `駅${stations.length + 1}`;
        marker.bindTooltip(name, { permanent: true, direction: "top", offset: [0, -10] }).openTooltip();

        const stationObj = { id: stations.length + 1, name, marker, pos: e.latlng };
        stations.push(stationObj);
        marker.on("click", (ev) => onStationClick(ev, stationObj));

        document.getElementById("stationCount").textContent = stations.length;
      }
    });

    // ===== 駅クリック処理 =====
    function onStationClick(e, stationObj) {
      if (mode === "track") {
        selectedStations.push(stationObj);
        stationObj.marker._icon.classList.add("selected");

        if (selectedStations.length === 2) {
          const [a, b] = selectedStations;
          const line = L.polyline([a.pos, b.pos], { color: "#8ecae6", weight: 3 }).addTo(map);
          tracks.push({ id: tracks.length + 1, stations: [a.id, b.id], line });
          document.getElementById("trackCount").textContent = tracks.length;
          selectedStations.forEach(s => s.marker._icon.classList.remove("selected"));
          selectedStations = [];
        }
      }
    }

    // ===== 線路接続 =====
    document.getElementById("btnConnect").addEventListener("click", () => {
      mode = (mode === "track") ? null : "track";
      selectedStations = [];
      infoBox.textContent = mode ? "線路接続モード：駅を2つクリック" : "東京全域マップ — 左下で操作";
    });

    // ===== 路線作成 =====
    document.getElementById("btnCreateRoute").addEventListener("click", () => {
      mode = (mode === "route") ? null : "route";
      selectedTracks = [];
      if (tempLine) { map.removeLayer(tempLine); tempLine = null; }
      infoBox.textContent = mode ? "路線作成モード：線路をクリックでルートを選択" : "東京全域マップ — 左下で操作";
    });

    map.on("click", (e) => {
      if (mode === "route") {
        tracks.forEach(track => {
          const dist = map.distance(e.latlng, track.line.getCenter());
          if (dist < 200) {
            if (!selectedTracks.includes(track)) {
              selectedTracks.push(track);
              track.line.setStyle({ color: "cyan", weight: 5 });
            } else {
              selectedTracks = selectedTracks.filter(t => t !== track);
              track.line.setStyle({ color: "#8ecae6", weight: 3 });
            }
          }
        });
      }
    });

    // ===== 路線登録 =====
    document.getElementById("btnRegisterRoute").addEventListener("click", () => {
      if (selectedTracks.length === 0) {
        alert("線路を選択してください。");
        return;
      }
      const name = prompt("路線名を入力：");
      if (!name) return;

      routes.push({
        id: routes.length + 1,
        name,
        tracks: selectedTracks.map(t => t.id)
      });

      document.getElementById("routeCount").textContent = routes.length;
      alert(`「${name}」を登録しました！`);

      selectedTracks.forEach(t => t.line.setStyle({ color: "#8ecae6", weight: 3 }));
      selectedTracks = [];
      mode = null;
      infoBox.textContent = "東京全域マップ — 左下で操作";
    });
  </script>
</body>
</html>
