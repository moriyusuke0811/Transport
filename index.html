<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>鉄道シミュレーター（淡色版）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      margin: 0;
      background: #0e0e11;
      color: #eee;
      font-family: "Segoe UI", sans-serif;
    }
    #map {
      width: 100%;
      height: 90vh;
      filter: brightness(0.9) contrast(0.9) saturate(0.7);
    }
    .menu-bar {
      display: flex;
      background: #1b1b22;
      border-bottom: 2px solid #333;
    }
    .menu-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: #1b1b22;
      color: #aaa;
      cursor: pointer;
      transition: 0.2s;
      font-weight: bold;
    }
    .menu-btn.active {
      background: #2c7dce;
      color: #fff;
    }
    .panel {
      display: none;
      background: #1b1b22;
      padding: 8px;
    }
    .panel.active {
      display: block;
    }
    .button {
      background: #2c7dce;
      border: none;
      color: white;
      padding: 5px 12px;
      margin: 3px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
    }
    .button.active {
      background: #facc15;
      color: #000;
    }
    #budget {
      padding: 6px 10px;
      background: #111;
      color: #7ff;
      position: absolute;
      top: 10px;
      right: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="menu-bar">
    <button class="menu-btn active" onclick="showTab('construction')">建設メニュー</button>
    <button class="menu-btn" onclick="showTab('routes')">路線メニュー</button>
    <button class="menu-btn" onclick="showTab('vehicles')">車両メニュー</button>
    <button class="menu-btn" onclick="showTab('stats')">統計メニュー</button>
  </div>

  <div id="construction" class="panel active">
    <button class="button" id="stationBtn" onclick="setMode('station')">駅設置</button>
    <button class="button" id="trackBtn" onclick="setMode('track')">線路敷設</button>
    <button class="button" id="undoBtn" onclick="undoTrack()">一つ戻る</button>
    <button class="button" id="cancelBtn" onclick="cancelTemp()">キャンセル</button>
    <button class="button" id="confirmBtn" onclick="confirmPlacement()">確定</button>
    <span id="costPreview">必要金額: 0</span>
  </div>

  <div id="routes" class="panel">
    <button class="button" onclick="setMode('route')">路線作成</button>
    <button class="button" onclick="finalizeRoute()">路線確定</button>
  </div>

  <div id="vehicles" class="panel">
    <p>車両購入・割当メニュー（仮）</p>
  </div>

  <div id="stats" class="panel">
    <p>利用データ・収支グラフ（仮）</p>
  </div>

  <div id="map"></div>
  <div id="budget">資金: ¥<span id="budgetValue">1000000</span></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([35.6812,139.7671], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
      attribution:'&copy; OpenStreetMap & Carto',
      maxZoom:19
    }).addTo(map);

    const DB = { stations:{}, tracks:{}, routes:{} };
    let currentMode=null, tempStation=null, tempTrackPoints=[], budget=1000000;
    let nextStationId=1, nextTrackId=1, tempRoute=[];
    const tempLayers=[];

    function showTab(id){
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`[onclick="showTab('${id}')"]`).classList.add('active');
    }

    function setMode(mode){
      currentMode=mode;
      document.querySelectorAll('.button').forEach(b=>b.classList.remove('active'));
      if(mode==='station') document.getElementById('stationBtn').classList.add('active');
      if(mode==='track') document.getElementById('trackBtn').classList.add('active');
      if(mode==='route') alert('駅を順にクリックして路線登録します');
    }

    map.on('click', e=>{
      if(currentMode==='station') createTempStation(e.latlng);
      if(currentMode==='track') addTrackPoint(e.latlng);
      if(currentMode==='route') selectStationForRoute(e.latlng);
    });

    function createTempStation(latlng){
      if(tempStation) map.removeLayer(tempStation.marker);
      tempStation = {
        latlng,
        marker:L.circleMarker(latlng,{radius:5,color:'#facc15'}).addTo(map)
      };
      document.getElementById('costPreview').textContent='必要金額: ¥50000';
    }

    function addTrackPoint(latlng){
      tempTrackPoints.push(latlng);
      const pt=L.circleMarker(latlng,{radius:4,color:'#5aa0f0'}).addTo(map);
      tempLayers.push(pt);
      if(tempTrackPoints.length>1){
        const ln=L.polyline([tempTrackPoints[tempTrackPoints.length-2],latlng],
          {color:'#2c7dce',weight:2,opacity:0.6,dashArray:'6,6'}).addTo(map);
        tempLayers.push(ln);
      }
      document.getElementById('costPreview').textContent=`必要金額: ¥${tempTrackPoints.length*10000}`;
    }

    function undoTrack(){
      if(tempTrackPoints.length>0){
        tempTrackPoints.pop();
        const layer=tempLayers.pop();
        if(layer) map.removeLayer(layer);
        document.getElementById('costPreview').textContent=`必要金額: ¥${tempTrackPoints.length*10000}`;
      }
    }

    function cancelTemp(){
      tempTrackPoints=[];
      if(tempStation){map.removeLayer(tempStation.marker);tempStation=null;}
      tempLayers.forEach(l=>map.removeLayer(l));
      tempLayers.length=0;
      document.getElementById('costPreview').textContent='必要金額: 0';
    }

    function confirmPlacement(){
      if(currentMode==='station' && tempStation){
        const id='S'+nextStationId++;
        const marker=L.circleMarker(tempStation.latlng,{
          radius:8,color:'#2c7dce',fillColor:'#2c7dce',fillOpacity:1
        }).addTo(map);
        DB.stations[id]={id,marker,latlng:tempStation.latlng};
        budget-=50000;
        updateBudget();
        map.removeLayer(tempStation.marker);
        tempStation=null;
        document.getElementById('costPreview').textContent='必要金額: 0';
      }
      if(currentMode==='track' && tempTrackPoints.length>1){
        for(let i=0;i<tempTrackPoints.length-1;i++){
          const id='T'+nextTrackId++;
          const line=L.polyline([tempTrackPoints[i],tempTrackPoints[i+1]],
            {color:'#2c7dce',weight:3}).addTo(map);
          DB.tracks[id]={id,line};
        }
        budget-=tempTrackPoints.length*10000;
        updateBudget();
        cancelTemp();
      }
    }

    function selectStationForRoute(latlng){
      let nearest=null,min=9999;
      for(const id in DB.stations){
        const s=DB.stations[id];
        const d=map.distance(latlng,s.latlng);
        if(d<100 && d<min){nearest=id;min=d;}
      }
      if(nearest) tempRoute.push(nearest);
    }

    function finalizeRoute(){
      if(tempRoute.length<2){alert('2駅以上選択してください');return;}
      alert(`路線登録: ${tempRoute.join(' → ')}`);
      tempRoute=[];
    }

    function updateBudget(){
      document.getElementById('budgetValue').textContent=budget;
    }
  </script>
</body>
</html>
